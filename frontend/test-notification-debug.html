<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Notification System Debug Test</h1>
        <p>This page helps debug the notification system by directly testing localStorage operations.</p>
        
        <div class="test-section">
            <h3>üìã User Selection</h3>
            <label>Test User ID: 
                <select id="userSelect">
                    <option value="1">User 1 (Admin)</option>
                    <option value="2" selected>User 2 (John Doe)</option>
                    <option value="3">User 3 (Jane Smith)</option>
                    <option value="4">User 4 (Bob Johnson)</option>
                    <option value="20">User 20 (Test User)</option>
                    <option value="21">User 21 (Test User)</option>
                </select>
            </label>
        </div>

        <div class="test-section">
            <h3>üß™ Test Actions</h3>
            <button onclick="sendTestNotification()">Send Test Meeting Notification</button>
            <button onclick="checkNotifications()">Check Notifications</button>
            <button onclick="clearNotifications()">Clear All Notifications</button>
            <button onclick="triggerUpdateEvent()">Trigger Update Event</button>
        </div>

        <div class="test-section">
            <h3>üìä Notification Status</h3>
            <div id="status">Ready to test...</div>
        </div>

        <div class="test-section">
            <h3>üìù Debug Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>üîç localStorage Inspector</h3>
            <button onclick="inspectLocalStorage()">Inspect All Notification Keys</button>
            <div id="inspector"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : 
                              type === 'error' ? 'error' : 
                              type === 'warning' ? 'warning' : 'info';
            
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function getSelectedUserId() {
            return Number(document.getElementById('userSelect').value);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<span class="${type}">${message}</span>`;
        }

        function sendTestNotification() {
            const userId = getSelectedUserId();
            log(`üß™ Sending test notification to user ${userId}...`);
            
            try {
                const notification = {
                    id: Date.now() + Math.random(),
                    type: 'MEETING_INVITATION',
                    title: 'DEBUG: Test Meeting Invitation',
                    message: `You've been invited to "DEBUG Test Meeting" on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}. This is a test notification.`,
                    timestamp: new Date().toISOString(),
                    read: false,
                    data: {
                        meetingId: 999,
                        meetingTitle: 'DEBUG Test Meeting',
                        meetingDate: new Date().toLocaleDateString(),
                        meetingTime: new Date().toLocaleTimeString(),
                        jitsiLink: 'https://meet.jit.si/debug-test'
                    }
                };

                const notifKey = `notifications_${userId}`;
                const existingNotifs = localStorage.getItem(notifKey);
                const notifs = existingNotifs ? JSON.parse(existingNotifs) : [];
                notifs.unshift(notification);
                localStorage.setItem(notifKey, JSON.stringify(notifs));

                log(`‚úÖ Notification stored in localStorage with key: ${notifKey}`, 'success');
                log(`üì¶ Total notifications for user ${userId}: ${notifs.length}`, 'info');
                
                // Trigger update event
                window.dispatchEvent(new CustomEvent('notificationsUpdated', {
                    detail: { userId: userId }
                }));
                
                log(`üì° Dispatched notificationsUpdated event for user ${userId}`, 'success');
                updateStatus(`‚úÖ Test notification sent to user ${userId}`, 'success');
                
                return notification;
            } catch (error) {
                log(`‚ùå Error sending notification: ${error.message}`, 'error');
                updateStatus(`‚ùå Failed to send notification: ${error.message}`, 'error');
                return null;
            }
        }

        function checkNotifications() {
            const userId = getSelectedUserId();
            log(`üîç Checking notifications for user ${userId}...`);
            
            try {
                const notifKey = `notifications_${userId}`;
                const stored = localStorage.getItem(notifKey);
                
                if (stored) {
                    const notifications = JSON.parse(stored);
                    log(`üì¨ Found ${notifications.length} notifications for user ${userId}:`, 'success');
                    
                    notifications.forEach((notif, index) => {
                        const status = notif.read ? 'Read' : 'Unread';
                        log(`  ${index + 1}. ${notif.title} (${notif.type}) - ${status}`, 'info');
                    });
                    
                    const unreadCount = notifications.filter(n => !n.read).length;
                    updateStatus(`üì¨ User ${userId}: ${notifications.length} total, ${unreadCount} unread`, 'info');
                    
                    return notifications;
                } else {
                    log(`üì≠ No notifications found for user ${userId}`, 'warning');
                    updateStatus(`üì≠ No notifications found for user ${userId}`, 'warning');
                    return [];
                }
            } catch (error) {
                log(`‚ùå Error checking notifications: ${error.message}`, 'error');
                updateStatus(`‚ùå Error checking notifications: ${error.message}`, 'error');
                return [];
            }
        }

        function clearNotifications() {
            const userId = getSelectedUserId();
            log(`üóëÔ∏è Clearing notifications for user ${userId}...`);
            
            try {
                const notifKey = `notifications_${userId}`;
                localStorage.removeItem(notifKey);
                
                // Trigger update event
                window.dispatchEvent(new CustomEvent('notificationsUpdated', {
                    detail: { userId: userId }
                }));
                
                log(`‚úÖ Cleared notifications for user ${userId}`, 'success');
                updateStatus(`‚úÖ Notifications cleared for user ${userId}`, 'success');
            } catch (error) {
                log(`‚ùå Error clearing notifications: ${error.message}`, 'error');
                updateStatus(`‚ùå Error clearing notifications: ${error.message}`, 'error');
            }
        }

        function triggerUpdateEvent() {
            const userId = getSelectedUserId();
            log(`üì° Manually triggering notificationsUpdated event for user ${userId}...`);
            
            window.dispatchEvent(new CustomEvent('notificationsUpdated', {
                detail: { userId: userId }
            }));
            
            log(`‚úÖ Event dispatched`, 'success');
            updateStatus(`üì° Update event triggered for user ${userId}`, 'info');
        }

        function inspectLocalStorage() {
            log(`üîç Inspecting localStorage for notification keys...`);
            
            const inspector = document.getElementById('inspector');
            let html = '<h4>üì¶ localStorage Notification Keys:</h4>';
            
            let found = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('notifications_')) {
                    found = true;
                    const value = localStorage.getItem(key);
                    try {
                        const notifications = JSON.parse(value);
                        const unreadCount = notifications.filter(n => !n.read).length;
                        html += `<div style="margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 5px;">
                            <strong>${key}</strong>: ${notifications.length} notifications (${unreadCount} unread)
                            <br><small>Last updated: ${notifications[0]?.timestamp || 'N/A'}</small>
                        </div>`;
                        log(`üì¶ ${key}: ${notifications.length} notifications (${unreadCount} unread)`, 'info');
                    } catch (error) {
                        html += `<div style="margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 5px;">
                            <strong>${key}</strong>: Invalid JSON data
                        </div>`;
                        log(`‚ùå ${key}: Invalid JSON data`, 'error');
                    }
                }
            }
            
            if (!found) {
                html += '<p style="color: #6c757d;">No notification keys found in localStorage</p>';
                log(`üì≠ No notification keys found in localStorage`, 'warning');
            }
            
            inspector.innerHTML = html;
        }

        // Listen for notification events
        window.addEventListener('notificationsUpdated', (e) => {
            const userId = e.detail?.userId;
            log(`üì° Received notificationsUpdated event for user ${userId}`, 'info');
        });

        // Initial status
        updateStatus('Ready to test notifications', 'info');
        log('üöÄ Notification debug test page loaded', 'success');
    </script>
</body>
</html>